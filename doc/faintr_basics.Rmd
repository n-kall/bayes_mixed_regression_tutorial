---
title: "Comparing groups of factor levels with the `faintr` package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Comparing groups of factor levels with the `faintr` package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      collapse = TRUE,
                      cache = TRUE,
                      dev.args = list(bg = "transparent"),
                      fig.align = "center",
                      fig.height = 3,
                      fig.widht = 4)
library(tidyverse)
theme_set(theme_bw() + theme(plot.background=element_blank()) )
```

# Motivation

The `faintr` package provides convenience function for the evaluation
of a model fit, obtained with the `brms` package, for a Bayesian
regression model for data from a factorial design. If the original
model fit used (default) dummy coding of factors, the `faintr` package
allows extraction of many more meaningful comparisons. For example, it
is possible to directly compare the difference between cells which are
not comparable by dummy coding, and it is also possible to compare
means in sets of cells, so as to recover the outcomes of deviance
coding.

# Installation

Install the `faintr` package with `devtools` from GitHub:

```{r, eval = F}
devtools::install_github(
  "n-kall/faintr",
  build_vignettes = TRUE
)
library(faintr)
```

```{r, echo = F}
library(faintr)
```

# Example

Consider a data set on pitch frequency in the speech of female and
male speakers in polite and informal contexts.

```{r, error=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
data(politeness)
```

The cell means of this data set are:

```{r}
politeness %>%
    group_by(gender, context) %>%
    summarize(mean_pitch = mean(pitch))
```


A Bayesian regression model for a factorial design with by-subject and
by-item random intercepts can be obtained with the `brms` package as
follows:

```{r, error=FALSE, warning=FALSE, message=FALSE, results="hide"}
library(brms)
m_dummy <- brm(pitch ~ gender * context + (1 | subject + sentence), politeness)
```

The `brm` function uses dummy coding per default.  Look at the
estimated coefficients:

```{r }
fixef(m_dummy)
```

The reference cell is where `gender == F` and `context == inf`, so female
speakers in informal contexts. The estimated mean for the cell with
data from male speakers in informal contexts is retrievable by adding
the estimated coefficient `genderM` in the output above from the
estimated Intercept.

The `faintr` package provides convenience functions to compare
different (groups of) cells to each other, based on a model fit like
the above. Although the fit of the regression model uses a particular
reference cell for dummy-coding, other contrasts of relevance can be
retrieved from the posterior samples. For example, if we want to
compare two cell diagonally, say, male speakers in informal contexts
against female speakers in polite contexts, we can do this by first
exracting the draws.

```{r }
female_polite <- faintr::filter_draws(m_dummy, gender == "F", context == "pol")
male_informal <- faintr::filter_draws(m_dummy, gender == "M", context == "inf")
```

We can then calculate and visualise the difference

```{r }
library(ggplot2)

diff <- pull(female_polite) - pull(male_informal)

mean(diff)

qplot(diff, geom = "density")

```

Or we can plot the two posteriors for a visual comparison.

```{r} 

library(ggplot2)

bind_cols(female_polite, male_informal) %>%
  gather(key = "cell") %>%
  ggplot(aes(x = value, color = cell, fill = cell)) +
  geom_density(alpha = 0.5)

```
